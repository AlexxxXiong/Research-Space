# Unity: Accelerating DNN Training Through Joint Optimization of Algebraic Transformations and Parallelization

Unity 在 FlexFlow、TASO 和 MetaFlow 的基础上，提出**在并行计算图（PCG）中代数变换和并行化的统一表示（OP，Operator）和共优化（图替代，Substitution）方法**，可以**同时考虑分布式训练中的计算、并行和通信过程**。对于**共优化**，Unity 使用一个**多级搜索算法**来**高效搜索性能最好的图替代组合以及相应的硬件放置策略**。

----------

###### Part 1. 并行基本形式的定义和传统计算图表示的局限

Unity 基于先前工作，定义了 **DNN 并行系统中常见的六类基本形式**：

- **数据并行**（Data Parallelism）：最基本的并行形式；
- **模型并行**（Model Parallelism）：将 DNN 模型拆分为多个子模型，分别在特定的设备训练；
- **空间并行**（Spatial Parallelism）：对 tensor 的空间维度（如图像的高/宽）进行划分；
- **规约并行**（Reduction Parallelism）：利用 OP 的线性。将 tensor 划分为 n 份到 n 个设备上，分别进行 OP 操作。注意每个结果 tensor 的 shape 都和最终 tensor 相同，因此只需相加进行规约；
- **管道并行**（Pipeline Parallelism）：不同训练代数之间的并行；
- **指定 OP 的并行**（Operator-specific Parallelsim）：对 batch 内不同的输入 sample 有不同的 weight，不需要 tensor 备份或同步；

许多并行策略是不同 cost 指标的 trade-off，因此需要不同 OP 用不同的并行方式，以达到最优性能。**DNN 结构表示的传统方法是计算图，节点是 OP，边是 tensor，代数变换被表示为迭代的图替代，通过给每个节点分配并行注释来并行化模型**。然而，该方法存在如下局限：

- 对代数变换和并行化使用独立表示阻碍了共优化。代数变换会增删节点，但并行化需要静态计算图；
- 计算图并没有显式考虑并行带来的通信开销。这导致代数变换难以预测最终模型的性能

-------------

###### Part 2. 并行计算图 PCG 的构造和相关表示

**PCG 的构造规则**：在 PCG 中，节点表示并行 OP（表示已有的并行策略，显式表示数据移动和相应的开销）和 tensor OP，边表示 tensor 的数据移动和数据依赖关系。每个 OP 均绑定一个设备映射。

**并行 OP**：Unity 主要考虑六类并行策略，两两分为三大类：

- **划分（Partition）和组合（Combine）**：可以改变 tensor **除 replica 以外维度的并行 degree**；
- **复制（Replication）和规约（Reduce）**：可以改变 tensor **replica 维度的并行 degree**；
- **管道（Pipeline）和批处理（Batch）**：管道**将 tensor 沿某个维度等大小地划分为多个子 batch，串行处理**（并未更改 tensor 的并行 degree，weight 需要和子 batch 相同 size）；批处理将多代的 tensors 聚合在一起

**Tensor 的表示方法**：**按数据维度对 tensor 进行建模，包含 size 和 degree（该维度划分数）字段**。每个 tensor 还有一个 **replica 维度**，表示该 tensor 数据的副本数。

**设备映射**：**n 维数组来表示每个 OP 每份运算在哪个设备上运行，n 是并行维度的数目**。例如，若 n=3，则将设备组织为三维阵列并序列化，以供**该 OP 划分后任务到设备的映射**。**维度也和设备的拓扑结构相关**，一个例子是，模型并行优先在连接相同 CPU 的 GPU 上进行，规约并行优先在相同节点但不同 CPU 上的 GPU 进行，数据并行优先在不同节点间进行。Unity 预设了多种有效利用设备并行的设备映射，开发者也可为特定硬件结构注册自定义映射。例如为节点对在映射种添加额外维度。

-----------

###### Part 3. 图替代的生成和验证

**图替代**：共优化的有效性依赖于选择一组合适的图替代。Unity **将大而复杂地代数变换和并行策略表示为多个小 PCG 替代的组合**。Unity **使用 TASO 提出的超优化方法，先用启发式来生成并识别候选替代，再用开销更大的验证方法来检验替代的正确性**。

- **替代生成**：Unity 在固定图 size 内**枚举所有可能的 PCG**（忽略过大的，不影响能应用变换的 size，可组合）。对每个生成的 PCG，Unity **计算一个指纹**（Fingerprint，输入特定 tensor 时输出 tensor 的哈希），该指纹函数被**拓展以包含每个维度的并行 degree**。**若一对 PCG 有相同的指纹，则是一个候选替代**；
- **替代验证**：**可离线**。Unity 使用**自动理论证明器 Z3**。其中，**OP 性质以一阶逻辑演算的方式被提供**，**OP 表述为输入和并行度的函数**（Partition 等可能还需要提供并行维度的信息）。**OP 性质以一阶逻辑演算的方式被提供**，**OP 表述为输入和配置参数的函数**（Parti 等 OP 还需要提供 dim 信息）；尝试**用 Z3 验证所有候选替代**，若某个替代正确但不能被验证，则**添加缺失的 OP properties**，重复直到 Unity 引入的全部新替代都被验证。

-------

###### Part 4. 共优化及三级分层搜索算法

**共优化**：核心问题是给定 1) **PCG**；2) **OP 级别设备映射的集合**；3) **PCG 替代的集合**，找 1) **PCG 替代的序列**；2) **结果 PCG 的设备映射**，从而**最小化每代的训练时间**。

**三级分层搜索算法**：**将 PCG 输入划分为多个子图，为每个子图选择优化后的替代序列和设备映射，再将这些子方案组合为最终的输出**。

- **PCG 替代序列**：Unity **使用 TASO 基于 cost 的回溯搜索算法来计算 PCG 的替代序列，以最小化执行时间**。Unity **维护一个替代序列的队列（由执行时间排序**），在空或满之前迭代**移除最好的候选**，并通过对其**应用每个可行的替代来生成新的候选**，若候选执行时间长于 thr 倍目前已知最优候选 PCG 的时间，则被剪枝；否则加入队列。
- **PCG 图分裂及设备映射优化**：Unity **通过序列图分裂和并行图分裂来递归分解线性和并行链为独立子图（直到无法分解），基于动态规划的思想**。
    - **序列图分裂**：在输入 PCG G 中找到一个**支配节点 n**（所有从输入到输出的路径都经过 n），并**在 n 将 G 划分为两个独立子图 G_1 和 G_2**（G_2 的 OP 等到 G_1 OP 全部完成才能开始）。该方法将找到 G 的最优设备映射规约为找到 G_1，G_2 的最优映射以及最优的 n；
    - **并行图分裂**：将 PCG G **划分为可并行计算的独立子图 G_1 和 G_2**，包含**串行（全部硬件资源）和并行（共享硬件资源）两类运行方案**，Unity 选择执行时间更短的哪个。为了**在并行时划分可用资源**，Unity **迭代遍历所有可能的资源量分配方案**，忽略是仅 GPU 序号不同（而不是数量和位置不同）的方案，将指数搜索替换为二次搜索；

**相关 PCG 的映射信息存储在交叉调用缓存**，因为存在替代关系的 PCG 间大部分图结构相同，可**复用**。

**为了解决扩展性的问题，Unity 将 PCG 分解为独立的串行子图**，但这样会**无法在子图间进行图替代**，而 Unity **用替代来表示并行**。因此这会**将跨子图间的并行度降为 1**，从而导致很多并行策略无法考虑。 

对此，Unity 通过**显式搜索子图间的最优并行化**来解决该问题，必须**保证前一个子图的输出 tensor 和后一个子图的输入 tensor 都符合考虑的划分，否则插入并行 OP 来调整，并考虑该操作带来的额外通信开销**（即先遍历子图间 tensor 可能的合法划分，再根据该划分在两个 OP 内添加需要的并行 OP）。参考 MetaFlow，Unity **选择破坏最少替代的子图划分位置，并保持子图 size 不超过 k**。

这样做可以将最坏候选 PCG 数目从 g 的指数降为 g 的线性。

**Cost 评估**：OP 运行时间和通信开销的评估**与 OptCNN 和 FlexFlow 的方法一致**。

**管道并行**：使用 **1F1B 调度和 weight update semantics**，**仅考虑应用在所有 OP 的管道并行**（否则会产生瓶颈），**每个 stage 仅和下一个 stage 通信**，且假设 mini-batch 里的 micro-batch 比 pipeline stages 显著多，这样 pipeline 的初始延迟可被忽略。管道并行时的搜索算法**直接以最大化吞吐为优化目标**（而非以最小化每代运行时间）。

---------

###### Part 5. 总结

整篇 paper 最 fancy 的地方在于**更新了六大类并行策略的定义**（虽然感觉还不是很系统，彼此界限不明晰），**提出并行计算图 PCG 将代数变换和并行策略统一表示为 OP**，通过**图替代的方式进行共优化**，并**通过三层分级搜索算法获取最优 PCG 替代序列及相应的底层设备映射**。
