# (OptCNN) Exploring Hidden Dimensions in Parallelizing Convolutional Neural Networks

OptCNN 提出 **layer 内部级别的并行**，允许每个 layer 有各自的并行策略，通过**解决图搜索问题来共优化**。OptCNN 能够**提高训练吞吐**，**减少通信开销**并达到**更好的扩展性**。

-----------

###### Part 1. Layer 级别并行的定义和阐述

对于模型并行，OptCNN **仅针对每个 layer 内部的参数并行**，而**不研究 layer (op) 级别的并行**。在**处理 2D 图像的标准 CNN** 中，**数据一般为四维张量 (sample, height, width, channel)**。Sample 包括训练集中的 idx（形状意义上为 bs），height 和 width 是图像中的位置（形状意义上为高和宽），channel 是该位置神经元的索引（形状意义上为通道数）。

探索这些其他维度的并行策略包括如下优势：

- 优势一：不同的 layer 采用不同维度的并行策略，可能会有**更好的执行时间性能表现**；
- 优势二：探索其他维度的并行策略能够**减少通信开销**；
- 优势三：**不同 layers 对并行度（并行机器数目）的偏好不同**，进而影响性能

一个**其他维度并行策略的例子是无需参数同步，只有数据传输的 channel 并行**。这里数据传输里 input tensors 最大不会超过输入 batch （比如小于32MB）。全连接层约等于（包括）卷积层，因此这里 channel 并行是每个卷积核的将一半的 channels （共 N 个 channels）分别存储在两个 GPU 上，计算这层卷积时某个 sample 一半 channel 和 GPU 1 上的卷积核 k channel 卷积（得到 N /2 个值），另一半 channel 和 GPU 2 上的卷积（得到 N / 2 个值），然后再通过数据传输加起来，这就是全连接层其中的一个值。若一共 K 个卷积核，则全连接层的输出维度为 K。

---------

###### Part 2. 计算图的构造及剪枝 & cost 模型及优化问题的定义

OptCNN 通过**设备图（对可用设备及连接建模）**和**计算图（定义映射到设备图上的 NN）**来**定义并行问题**，通过**定义输出张量如何被划分**来描述 **layer 的并行化**，通过**并行配置**定义**该 layer 如何在多设备间并行**。OptCNN 为 layer 定义了三类时间，进而通过 simulation 评估特定策略的时间性能：

- **t_c 同时包括 fp 和 bp 的时间**，通过当前配置下 layer 在设备上处理多次并取平均 t 得到；
- **t_x 表示将输入张量传输到目标设备的时间**，使用数据大小和已知的通信带宽相除获得理论值；
- **t_s 表示 bp 后该 layer 同步参数的时间**，适用于面向 layer 的 PS （及其他？）架构（与数据并行的 ps 架构区别），用通信时间近似参数同步时间（忽略 ps 上的更新时间）

OptCNN 的**优化目标是最小化 t_o = sum_{i}(t_c + t_x + t_s)**。OptCNN 提出了**两类 reduction 方法**：

- 方法一：**Node elimination**。**将计算图中入度和出度均为 1 的 layer 去掉**，用 layer 上的 t_c，t_s 以及进出两条边的 t_x 来**定义新产生 edge 的 t_x**，并**使用动态规划来为该 layer 寻找一个最优的配置 c**，以**使得新的 t_x 最小**。如果去掉 layer 后的策略 S 最优，则加上 layer 的配置 c_j 后的 S' 也最优；
- 方法二：**Edge elimination**。**将计算图中源和目标节点都相同的两条 edge 合并为一条**，**新 t_x 等于原来两个 t_x 的和**。新的策略 S' 和老的策略 S 相同，若 S 是 G 的最优策略，则 S' 是 G' 的最优策略

----------------

###### Part 3. 基于动态规划的图搜索算法

OptCNN 采用**基于动态规划的图搜索算法**。算法流程是：

- 首先**迭代调用 node 和 edge elimination**，直到计算图无法 reduced；
- 然后**枚举获得计算图 G(m) 的最优策略 S(m)**，以**最小化 cost 函数（即总时间）t_o**；
- 随后**迭代反向撤销每次 elimination**（若是 node eli，则最小化 t_o 获得 c，且 S(i) = S(i+1) + c，否则为 edge eli，S(i) = S(i+1)）由定理知 S(i) 是 G(i) 的最优策略；
- 最终 **S(0) 即原计算图的最优策略**。

-----------

###### Part 4. 总结

整篇 paper 最 fancy 的地方在于**定义了 CNN 多维度并行策略的方法**，**基于多阶段时间的策略性能模拟评估**，以及**计算图的有效图搜索算法**。
